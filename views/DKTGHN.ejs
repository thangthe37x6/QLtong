<div class="md:pl-64">
  <!-- Ti√™u ƒë·ªÅ -->
  <div class="top-0 z-10 text-center py-6">
    <h1 class="text-2xl font-bold">ƒêƒÇNG K√ù THAM GIA HN</h1>
  </div>
  <!-- N·ªôi dung -->
  <main class="p-6">
    <div class="max-w-4xl mx-auto p-6">
      <form action="/DKTGHN" method="POST"
        class="bg-white shadow-md rounded-2xl p-6 md:p-8 space-y-6 max-w-5xl mx-auto">
        <div class="mb-4">
          <label class="block font-semibold">Ch·ªçn ng√†y t·ªï ch·ª©c:</label>
          <select id="ngayToChuc" class="border rounded p-2 w-full">
            <option value="">-- Ch·ªçn ng√†y --</option>
            <% uniqueDates.forEach(date=> { %>
              <option value="<%= date %>">
                <%= date %>
              </option>
              <% }) %>
          </select>
        </div>

        <div class="mb-4">
          <label class="block font-semibold">Ch·ªçn h·ªôi ngh·ªã:</label>
          <select name="idHoiNghi" id="hoiNghiSelect" class="border rounded p-2 w-full" required disabled>
            <option value="">-- Ch·ªçn h·ªôi ngh·ªã --</option>
          </select>
        </div>
        <div class="mb-4">
          <div id="infoSection" class="mt-6 hidden border p-4 rounded bg-gray-100">
            <p><strong>T√™n HN:</strong> <span id="tenHoiNghi"></span></p>
            <p><strong>Nh√≥m ph·ª• tr√°ch:</strong> <span id="nhomPhuTrach"></span></p>
            <p><strong>ƒê·ªãa ƒëi·ªÉm:</strong> <span id="diaDiem"></span></p>
            <p><strong>Loai h√¨nh:</strong> <span id="loaiHinh"></span></p>
            <p><strong>Ngay t·ªï ch·ª©c:</strong> <span id="ngayToChuc"></span></p>
            <p><strong>B·ªô ph·∫≠n xe:</strong> <span id="PC"></span></p>

          </div>
        </div>
        <!-- N√∫t x√°c nh·∫≠n -->
        <div class="pt-4 text-center">
          <button type="submit"
            class="bg-blue-600 text-white font-semibold py-3 px-8 rounded-full hover:bg-blue-700 transition duration-200 shadow-md">
            X√°c nh·∫≠n
          </button>
        </div>
      </form>

      <!-- B·∫£ng hi·ªÉn th·ªã h·ªôi ngh·ªã ƒë√£ ƒëƒÉng k√Ω -->
      <div id="bangHoiNghi" class="mt-10 hidden">
        <h3 class="text-lg font-bold mb-3">Danh s√°ch h·ªôi ngh·ªã b·∫°n ƒë√£ ƒëƒÉng k√Ω trong ng√†y</h3>
        <div class="overflow-x-auto rounded-2xl shadow-md border border-gray-300">
          <table class="w-full text-left bg-white overflow-hidden rounded-2xl">
            <thead class="bg-gray-100 text-gray-700">
              <tr>
                <th class="p-3 text-center">T√™n h·ªôi ngh·ªã</th>
                <th class="p-3 text-center">Ng√†y t·ªï ch·ª©c</th>
                <th class="p-3 text-center">Huy·ªán</th>
                <th class="p-3  text-center">ƒê·ªãa ƒëi·ªÉm</th>
                <th class="p-3 text-center">Lo·∫°i h√¨nh</th>
                <th class="p-3 text-center">Nh√≥m ph·ª• tr√°ch</th>
                <th class="p-3 text-center">Xe ph·ª• tr√°ch</th>
                <th class="p-3 text-center">H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody id="bodyHoiNghi" class="text-sm divide-y divide-gray-200 text-center">
              <!-- D·ªØ li·ªáu t·ª´ JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
  const ngayToChuc = document.getElementById('ngayToChuc');
  const hoiNghiSelect = document.getElementById('hoiNghiSelect');
  const bangHoiNghi = document.getElementById('bangHoiNghi');
  const bodyHoiNghi = document.getElementById('bodyHoiNghi');
  const infoSection = document.getElementById('infoSection');

  // H√†m t·∫£i danh s√°ch h·ªôi ngh·ªã theo ng√†y
  async function loadConferencesByDate(date) {
    const resConferences = await fetch(`/api/DKTGHN?date=${encodeURIComponent(date)}`);
    const conferences = await resConferences.json();

    hoiNghiSelect.innerHTML = `<option value="">-- Ch·ªçn h·ªôi ngh·ªã --</option>`;
    conferences.forEach(item => {
      hoiNghiSelect.innerHTML += `<option value="${item._id}">${item.tenHoiNghi}</option>`;
    });
    hoiNghiSelect.disabled = false;
  }

  // ‚úÖ H√†m hi·ªÉn th·ªã c√°c h·ªôi ngh·ªã ƒë√£ ƒëƒÉng k√Ω (KH√îNG ph·ª• thu·ªôc ng√†y)
  async function showRegisteredConferences() {
    const resRegistered = await fetch(`/api/user-conferences`);
    const registered = await resRegistered.json();

    if (registered.length > 0) {
      bangHoiNghi.classList.remove('hidden');
      bodyHoiNghi.innerHTML = '';
      registered.forEach(item => {
        bodyHoiNghi.innerHTML += `
          <tr class="border-t">
            <td class="p-2">${item.detailHN.tenHoiNghi}</td>
            <td class="p-2">${item.detailHN.ngayToChuc}</td>
            <td class="p-2">${item.detailHN.huyenToChuc}</td>
            <td class="p-2">${item.detailHN.diaDiem}</td>
            <td class="p-2">${item.detailHN.loaiHinh}</td>
            <td class="p-2">${item.detailHN.nhomPhuTrach}</td>
            <td class="p-2">${item.detailHN.PC || ''}</td>
            <td class="p-3 text-center">
             <button onclick="xoaHoiNghi('${item._id}')" class="text-red-600 hover:text-red-800 text-xl">x√≥a</button>

          </td>
          </tr>
        `;
      });
    } else {
      bangHoiNghi.classList.add('hidden');
    }
  }

  // S·ª± ki·ªán thay ƒë·ªïi ng√†y => ch·ªâ g·ªçi loadConferencesByDate
  ngayToChuc.addEventListener('change', async () => {
    const date = ngayToChuc.value;
    if (!date) return;
    await loadConferencesByDate(date);
  });
  hoiNghiSelect.addEventListener('change', async () => {
    const id = hoiNghiSelect.value;
    if (!id) return infoSection.classList.add('hidden');
    const res = await fetch(`/api/DKTGHN/${id}`);
    const info = await res.json();

    tenHoiNghi.textContent = info.tenHoiNghi;
    diaDiem.textContent = info.huyenToChuc + "," + info.diaDiem;
    nhomPhuTrach.textContent = info.nhomPhuTrach;
    loaiHinh.textContent = info.ngayToChuc;
    PC.textContent = info.PC;
    infoSection.classList.remove('hidden');
  })

  async function xoaHoiNghi(id) {
    console.log("üìå ID g·ª≠i ƒëi:", id);
    const confirmed = confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?');
    if (!confirmed) return;

    try {
      const res = await fetch(`/DKTGHN/delete/${id}`, {
        method: 'POST',
      });

      if (res.ok) {
        alert('ƒê√£ x√≥a th√†nh c√¥ng');
        showRegisteredConferences(); // C·∫≠p nh·∫≠t l·∫°i danh s√°ch sau khi x√≥a
      } else {
        const data = await res.json();
        alert('L·ªói khi x√≥a: ' + (data.error || 'Kh√¥ng r√µ'));
      }
    } catch (err) {
      console.error('L·ªói fetch khi x√≥a:', err);
      alert('L·ªói k·∫øt n·ªëi m√°y ch·ªß');
    }
  }
  // G·ªçi showRegisteredConferences ngay khi trang load (ho·∫∑c l√∫c b·∫°n c·∫ßn)
  document.addEventListener('DOMContentLoaded', () => {
    showRegisteredConferences();
  });
</script>